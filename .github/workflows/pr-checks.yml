name: Pull Request - Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # ========================================
  # Metadata & Information
  # ========================================
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‹ PR Details
        run: |
          echo "ğŸ” Pull Request Information"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "PR Number: #${{ github.event.pull_request.number }}"
          echo "Title: ${{ github.event.pull_request.title }}"
          echo "Author: ${{ github.event.pull_request.user.login }}"
          echo "Base Branch: ${{ github.event.pull_request.base.ref }}"
          echo "Head Branch: ${{ github.event.pull_request.head.ref }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # ========================================
  # Code Quality Checks
  # ========================================
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ” Check for secrets
        run: |
          # Check for common secret patterns
          if grep -r -E "(password|secret|key|token).*=.*['\"].*['\"]" --exclude-dir={node_modules,vendor,.git} . ; then
            echo "âš ï¸  Warning: Potential secrets found in code"
          else
            echo "âœ… No obvious secrets found"
          fi
      
      - name: ğŸ“Š Count changes
        run: |
          echo "ğŸ“ˆ Statistics:"
          echo "Files changed: $(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | wc -l)"
          echo "Lines added: $(git diff --stat origin/${{ github.event.pull_request.base.ref }}...HEAD | tail -1)"

  # ========================================
  # Docker Build Test
  # ========================================
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [frontend, backend]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ğŸ—ï¸ Build ${{ matrix.service }}
        run: |
          docker build \
            --file ./${{ matrix.service }}/Dockerfile \
            --tag asturing-${{ matrix.service }}:pr-${{ github.event.pull_request.number }} \
            ./${{ matrix.service }}
      
      - name: âœ… Build successful
        run: echo "âœ… Docker build for ${{ matrix.service }} completed successfully"

  # ========================================
  # Comment on PR
  # ========================================
  pr-comment:
    name: Update PR
    runs-on: ubuntu-latest
    needs: [quality, docker-build]
    if: always()
    
    steps:
      - name: ğŸ’¬ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const qualityStatus = '${{ needs.quality.result }}';
            const dockerStatus = '${{ needs.docker-build.result }}';
            
            let emoji = 'âœ…';
            let status = 'All checks passed!';
            
            if (qualityStatus !== 'success' || dockerStatus !== 'success') {
              emoji = 'âŒ';
              status = 'Some checks failed';
            }
            
            const body = `## ${emoji} CI/CD Status
            
            | Check | Status |
            |-------|--------|
            | Code Quality | ${qualityStatus === 'success' ? 'âœ…' : 'âŒ'} ${qualityStatus} |
            | Docker Build | ${dockerStatus === 'success' ? 'âœ…' : 'âŒ'} ${dockerStatus} |
            
            **${status}**
            
            ---
            *Automated check from GitHub Actions*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
