name: Cleanup & Maintenance

on:
  schedule:
    # Tous les dimanches Ã  3h00 UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:

jobs:
  cleanup-ghcr:
    name: Cleanup GHCR Images
    runs-on: ubuntu-latest
    permissions:
      packages: write
    
    steps:
      - name: ğŸ—‘ï¸ Delete old untagged images
        run: |
          echo "ğŸ” Listing old container images..."
          echo "âš ï¸  Manual cleanup required via GitHub UI"
          echo "Go to: Packages â†’ asturing-nuxt/asturing-symfony â†’ Manage versions"
  
  cleanup-server:
    name: Cleanup Production Server
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ§¹ Clean Docker resources
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ§¹ Docker Cleanup"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # ArrÃªt des containers non utilisÃ©s
            docker container prune -f
            
            # Suppression des images non utilisÃ©es
            docker image prune -a -f
            
            # Suppression des volumes non utilisÃ©s (ATTENTION!)
            # docker volume prune -f
            
            # Suppression des networks non utilisÃ©s
            docker network prune -f
            
            # Nettoyage complet du systÃ¨me
            docker system prune -a -f
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“Š Disk Space After Cleanup"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            df -h | grep -E '(Filesystem|/dev/)' || true
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ³ Docker Disk Usage After Cleanup"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            docker system df
            
            echo ""
            echo "âœ… Cleanup completed successfully"
      
      - name: ğŸ—‚ï¸ Clean old logs
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            
            echo "ğŸ—‚ï¸ Cleaning old log files..."
            
            # Nettoyer les logs Symfony (plus de 30 jours)
            find backend/var/log -name "*.log" -type f -mtime +30 -delete 2>/dev/null || true
            
            # Nettoyer les logs systÃ¨me si accessibles
            # sudo journalctl --vacuum-time=30d
            
            echo "âœ… Log cleanup completed"
      
      - name: ğŸ“Š Generate cleanup report
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Maintenance Report"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Date: $(date)"
          echo "Status: Completed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
