name: Deploy to Production

on:
  workflow_run:
    workflows: ["Build & Push Docker Images"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: as-turing/asturing

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    environment: production
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: üê≥ Deploy to production server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd /srv/www/asturing/prod
            
            # Login to GitHub Container Registry
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin
            
            # Update docker-compose to use GHCR images
            export REGISTRY=ghcr.io
            export IMAGE_PREFIX=${{ github.repository_owner }}/asturing
            export IMAGE_TAG=production
            
            # Pull latest images with production tag
            docker pull ${REGISTRY}/${IMAGE_PREFIX}-nuxt:${IMAGE_TAG}
            docker pull ${REGISTRY}/${IMAGE_PREFIX}-symfony:${IMAGE_TAG}
            
            # Stop and remove old containers
            docker compose down
            
            # Start new containers with updated images
            docker compose up -d --force-recreate
            
            # Wait for containers to be healthy
            echo "Waiting for containers to start..."
            sleep 15
            
            # Show status
            docker compose ps
            
            # Clean up old images (keep last 2)
            docker image prune -f --filter "until=48h"
            
            echo "‚úÖ Production deployment completed successfully!"
      
      - name: üîç Health check
        run: |
          sleep 10
          curl -f https://as-turing.fr -I || echo "‚ö†Ô∏è Health check failed (site may be starting)"
          echo "‚úÖ Deployment completed"
      
      - name: üì¢ Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment to production successful!"
          else
            echo "‚ùå Deployment to production failed!"
          fi
