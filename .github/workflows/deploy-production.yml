name: Deploy to Production

on:
  # workflow_run:
  #   workflows: ["Build & Push Docker Images"]
  #   types:
  #     - completed
  #   branches: [main, master]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/asturing

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    environment: production
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: üê≥ Deploy to production server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            
            # Login to GitHub Container Registry
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Pull latest images
            docker compose pull
            
            # Stop and remove old containers
            docker compose down
            
            # Start new containers
            docker compose up -d --force-recreate
            
            # Wait for containers to be healthy
            echo "Waiting for containers to start..."
            sleep 15
            
            # Show status
            docker compose ps
            
            # Clean up old images
            docker image prune -f
            
            echo "‚úÖ Deployment completed successfully!"
      
      - name: üîç Health check
        run: |
          sleep 10
          # Add your health check URL here when available
          # curl -f https://as-turing.fr || exit 1
          echo "‚úÖ Health check passed (placeholder)"
      
      - name: üì¢ Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment to production successful!"
          else
            echo "‚ùå Deployment to production failed!"
          fi
