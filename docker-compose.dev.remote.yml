# docker-compose.dev.remote.yml
# Usage on server (example):
#   cd /srv/www/asturing/dev
#   docker compose -f docker-compose.dev.remote.yml --env-file ./.env up -d
#
# This file is tailored for the remote dev server: it uses prebuilt images
# pushed by the develop CI and connects to the external Traefik network.
# It intentionally does NOT mount source volumes and does NOT build images.

networks:
  traefik:
    external: true

services:
  nuxt:
    image: chadowww/dev-nuxt:develop
    restart: unless-stopped
    networks: [traefik]
    environment:
      HOST: ${HOST:-0.0.0.0}
      NITRO_PORT: ${NITRO_PORT:-3000}
      NUXT_PUBLIC_API_BASE: ${NUXT_PUBLIC_API_BASE:-http://localhost/api}
      NODE_ENV: ${NODE_ENV:-development}
      NUXT_TELEMETRY_DISABLED: ${NUXT_TELEMETRY_DISABLED:-1}
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.asturing-front.rule=Host(`${DEV_DOMAIN}`) && PathPrefix(`/`)"
      - "traefik.http.routers.asturing-front.entrypoints=web"
      - "traefik.http.routers.asturing-front.priority=10"
      - "traefik.http.services.asturing-front.loadbalancer.server.port=${NITRO_PORT:-3000}"
      - "traefik.http.middlewares.asturing-auth.basicauth.users=${TRAEFIK_BASIC_AUTH_USERS:-}"
      - "traefik.http.routers.asturing-front.middlewares=asturing-auth"

  symfony:
    image: chadowww/dev-symfony:develop
    restart: unless-stopped
    networks: [traefik]
    environment:
      APP_ENV: ${APP_ENV:-dev}
      APP_SECRET: ${APP_SECRET:-devsecret}
      DATABASE_URL: ${DATABASE_URL:-mysql://userdb:passdb@mysql:3306/db}
      TRUSTED_PROXIES: ${TRUSTED_PROXIES:-0.0.0.0/0}
      TRUSTED_HOSTS: ${TRUSTED_HOSTS:-^.+$}
      # CORS_ALLOW_ORIGIN: ${CORS_ALLOW_ORIGIN:-}
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.asturing-api.rule=Host(`${DEV_DOMAIN}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.asturing-api.entrypoints=web"
      - "traefik.http.routers.asturing-api.priority=20"
      - "traefik.http.services.asturing-api.loadbalancer.server.port=80"
